generator client {
  provider = "prisma-client-js"
  
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//////////////////////////////
// ENUMS
//////////////////////////////

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ProcurementStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PURCHASED
  COMPLETED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LogLevel {
  INFO
  WARNING
  ERROR
}

enum PermissionModule {
  DASHBOARD
  PROCUREMENT
  REPORT
  DATA_SETUP
  ROLES_PERMISSION
  USER_MANAGEMENT
  SYSTEM_SETTINGS
}

//////////////////////////////
// USERS & RBAC
//////////////////////////////
model User {
  id       Int        @id @default(autoincrement())
  email    String     @unique
  password String
  fullName String
  status   UserStatus @default(ACTIVE)

  // ✅ SINGLE ROLE
  roleId Int
  role   Role @relation(fields: [roleId], references: [id])

  approvals           Approval[]
  logs                SystemLog[]
  proofs              ProcurementProof[]
  procurementRequests ProcurementRequest[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  users       User[]
  permissions RolePermission[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Permission {
  id          Int               @id @default(autoincrement())
  key         String            @unique
  description String?
  module      PermissionModule?

  roles RolePermission[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@id([roleId, permissionId])
}

//////////////////////////////
// PROGRAMS
//////////////////////////////

model Program {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?
  imageUrl    String?

  committeeInCharge String
  beneficiaries     String

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)

  allocations BudgetAllocation[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

//////////////////////////////
// FISCAL & BUDGETING
//////////////////////////////

model FiscalYear {
  id       Int     @id @default(autoincrement())
  year     Int     @unique
  isActive Boolean @default(false)

  budgets Budget[]

  createdAt DateTime  @default(now())
  deletedAt DateTime?
}

model Budget {
  id           Int     @id @default(autoincrement())
  fiscalYearId Int
  totalAmount  Decimal @db.Decimal(15, 2)

  fiscalYear  FiscalYear         @relation(fields: [fiscalYearId], references: [id])
  allocations BudgetAllocation[]

  /**
   * ✅ ADD THIS
   */
  classificationLimits BudgetClassificationLimit[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model BudgetClassification {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?

  allocations BudgetAllocation[]

  /**
   * ✅ ADD THIS
   */
  budgetLimits BudgetClassificationLimit[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model BudgetClassificationLimit {
  id               Int     @id @default(autoincrement())
  budgetId         Int
  classificationId Int
  limitAmount      Decimal @db.Decimal(15, 2)

  budget         Budget               @relation(fields: [budgetId], references: [id])
  classification BudgetClassification @relation(fields: [classificationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([budgetId, classificationId])
}

model ObjectOfExpenditure {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?

  allocations BudgetAllocation[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model BudgetAllocation {
  id                    Int     @id @default(autoincrement())
  budgetId              Int
  programId             Int
  classificationId      Int
  objectOfExpenditureId Int
  allocatedAmount       Decimal @db.Decimal(15, 2)
  usedAmount            Decimal @default(0) @db.Decimal(15, 2)

  budget         Budget               @relation(fields: [budgetId], references: [id])
  program        Program              @relation(fields: [programId], references: [id])
  classification BudgetClassification @relation(fields: [classificationId], references: [id])
  object         ObjectOfExpenditure  @relation(fields: [objectOfExpenditureId], references: [id])

  requests ProcurementRequest[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

//////////////////////////////
// PROCUREMENT
//////////////////////////////

model Vendor {
  id      Int     @id @default(autoincrement())
  name    String
  address String?
  contact String?

  requests ProcurementRequest[]

  createdAt DateTime  @default(now())
  deletedAt DateTime?
}

model ProcurementRequest {
  id          Int               @id @default(autoincrement())
  title       String
  description String?
  amount      Decimal           @db.Decimal(15, 2)
  status      ProcurementStatus @default(DRAFT)

  allocationId Int
  vendorId     Int?

  allocation BudgetAllocation @relation(fields: [allocationId], references: [id])
  vendor     Vendor?          @relation(fields: [vendorId], references: [id])

  approvals Approval[]
  items     ProcurementItem[]
  proofs    ProcurementProof[]

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model ProcurementItem {
  id        Int     @id @default(autoincrement())
  requestId Int
  name      String
  quantity  Int
  unitCost  Decimal @db.Decimal(15, 2)

  request ProcurementRequest @relation(fields: [requestId], references: [id])

  createdAt DateTime  @default(now())
  deletedAt DateTime?
}

model ProcurementProof {
  id          Int     @id @default(autoincrement())
  requestId   Int
  type        String
  fileUrl     String
  description String?

  uploadedById Int
  uploadedBy   User               @relation(fields: [uploadedById], references: [id])
  request      ProcurementRequest @relation(fields: [requestId], references: [id])

  createdAt DateTime  @default(now())
  deletedAt DateTime?
}

//////////////////////////////
// APPROVAL WORKFLOW
//////////////////////////////

model Approval {
  id         Int            @id @default(autoincrement())
  requestId  Int
  approverId Int
  status     ApprovalStatus @default(PENDING)
  remarks    String?

  request  ProcurementRequest @relation(fields: [requestId], references: [id])
  approver User               @relation(fields: [approverId], references: [id])

  createdAt DateTime  @default(now())
  deletedAt DateTime?
}

//////////////////////////////
// SYSTEM SETTINGS
//////////////////////////////

model SystemSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String

  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

//////////////////////////////
// SYSTEM LOGS
//////////////////////////////

model SystemLog {
  id      Int      @id @default(autoincrement())
  level   LogLevel
  message String
  context String?

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  createdAt DateTime  @default(now())
  deletedAt DateTime?
}
